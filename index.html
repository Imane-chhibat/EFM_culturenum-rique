<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tableau de Bord - Assurances Auto</title>

    <!-- Bootstrap 5 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css"
    />
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <!-- SheetJS pour lire les fichiers Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>

    <style>
      :root {
        --primary-color: #2c3e50;
        --secondary-color: #3498db;
        --accent-color: #e74c3c;
        --light-color: #ecf0f1;
        --dark-color: #2c3e50;
        --success-color: #27ae60;
        --warning-color: #f39c12;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f8f9fa;
        color: #333;
      }

      .navbar-brand {
        font-weight: 700;
        font-size: 1.5rem;
      }

      .card {
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: none;
        margin-bottom: 20px;
        transition: transform 0.3s;
      }

      .card:hover {
        transform: translateY(-5px);
      }

      .card-header {
        background-color: var(--primary-color);
        color: white;
        border-radius: 10px 10px 0 0 !important;
        font-weight: 600;
      }

      .indicator-card {
        text-align: center;
        padding: 20px 15px;
      }

      .indicator-value {
        font-size: 2.2rem;
        font-weight: 700;
        margin: 10px 0;
      }

      .indicator-label {
        font-size: 0.9rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .indicator-icon {
        font-size: 2.5rem;
        margin-bottom: 15px;
        color: var(--secondary-color);
      }

      .table-container {
        overflow-x: auto;
      }

      .data-table {
        width: 100%;
        font-size: 0.9rem;
      }

      .data-table thead th {
        background-color: var(--primary-color);
        color: white;
        border: none;
        position: sticky;
        top: 0;
      }

      .data-table tbody tr:hover {
        background-color: rgba(52, 152, 219, 0.1);
      }

      .filter-section {
        background-color: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 25px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      }

      .chart-container {
        height: 300px;
        position: relative;
      }

      .file-upload-area {
        border: 2px dashed var(--secondary-color);
        border-radius: 10px;
        padding: 40px 20px;
        text-align: center;
        background-color: rgba(52, 152, 219, 0.05);
        cursor: pointer;
        transition: all 0.3s;
      }

      .file-upload-area:hover {
        background-color: rgba(52, 152, 219, 0.1);
      }

      .file-upload-icon {
        font-size: 3rem;
        color: var(--secondary-color);
        margin-bottom: 15px;
      }

      .footer {
        background-color: var(--dark-color);
        color: white;
        padding: 20px 0;
        margin-top: 40px;
      }

      .badge-contract {
        background-color: var(--secondary-color);
      }

      .badge-premium {
        background-color: var(--success-color);
      }

      .badge-vehicle {
        background-color: var(--warning-color);
      }

      .btn-import {
        background-color: var(--secondary-color);
        color: white;
        font-weight: 600;
      }

      .btn-import:hover {
        background-color: #2980b9;
        color: white;
      }

      .stat-card {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
        .indicator-value {
          font-size: 1.8rem;
        }

        .chart-container {
          height: 250px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Navigation -->
    <nav
      class="navbar navbar-expand-lg navbar-dark"
      style="background-color: var(--primary-color)"
    >
      <div class="container-fluid">
        <a class="navbar-brand" href="#">
          <i class="bi bi-shield-check"></i> Tableau de Bord Assurances
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link active" href="#"
                ><i class="bi bi-house-door"></i> Accueil</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" id="importTab"
                ><i class="bi bi-upload"></i> Importer</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" id="dashboardTab"
                ><i class="bi bi-bar-chart"></i> Tableau de Bord</a
              >
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Main Container -->
    <div class="container-fluid mt-4">
      <!-- Import Section -->
      <div id="importSection" class="mb-5">
        <div class="row">
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <i class="bi bi-upload me-2"></i> Importer un fichier Excel
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6">
                    <div class="file-upload-area" id="dropArea">
                      <div class="file-upload-icon">
                        <i class="bi bi-file-earmark-excel"></i>
                      </div>
                      <h5>Glissez-déposez votre fichier Excel ici</h5>
                      <p class="text-muted">ou cliquez pour sélectionner</p>
                      <input
                        type="file"
                        id="fileInput"
                        accept=".xlsx, .xls"
                        class="d-none"
                      />
                      <button class="btn btn-import mt-3" id="selectFileBtn">
                        <i class="bi bi-folder2-open me-2"></i>Sélectionner un
                        fichier
                      </button>
                      <p class="mt-3 small text-muted">
                        Formats supportés: .xlsx, .xls
                      </p>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <h5>Instructions</h5>
                    <p>
                      Importez un fichier Excel contenant les données
                      d'assurances auto. Le fichier doit contenir les colonnes
                      suivantes :
                    </p>
                    <ul>
                      <li>ID_Client</li>
                      <li>Nom & Prénom</li>
                      <li>Ville</li>
                      <li>Type_Vehicule</li>
                      <li>Type_Assurance</li>
                      <li>Prime_Totale</li>
                    </ul>
                    <div class="alert alert-info">
                      <i class="bi bi-info-circle me-2"></i>
                      <strong>Exemple de fichier :</strong> Vous pouvez utiliser
                      le fichier "EFM.xlsx" fourni avec les données
                      d'assurances.
                    </div>
                  </div>
                </div>

                <div class="row mt-4">
                  <div class="col-12">
                    <div id="fileInfo" class="alert alert-secondary d-none">
                      <i class="bi bi-file-earmark-text me-2"></i>
                      <span id="fileName">Aucun fichier sélectionné</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Dashboard Section (initially hidden) -->
      <div id="dashboardSection" style="display: none">
        <!-- Key Indicators -->
        <div class="row mb-4">
          <div class="col-md-3 col-sm-6 mb-3">
            <div class="card indicator-card stat-card">
              <div class="card-body">
                <div class="indicator-icon">
                  <i class="bi bi-file-text"></i>
                </div>
                <div class="indicator-value" id="contractCount">20</div>
                <div class="indicator-label">Nombre de contrats</div>
              </div>
            </div>
          </div>
          <div class="col-md-3 col-sm-6 mb-3">
            <div class="card indicator-card stat-card">
              <div class="card-body">
                <div class="indicator-icon">
                  <i class="bi bi-cash-stack"></i>
                </div>
                <div class="indicator-value" id="avgPremium">2130</div>
                <div class="indicator-label">Prime moyenne (MAD)</div>
              </div>
            </div>
          </div>
          <div class="col-md-3 col-sm-6 mb-3">
            <div class="card indicator-card stat-card">
              <div class="card-body">
                <div class="indicator-icon">
                  <i class="bi bi-graph-up"></i>
                </div>
                <div class="indicator-value" id="totalPremium">42600</div>
                <div class="indicator-label">Prime totale (MAD)</div>
              </div>
            </div>
          </div>
          <div class="col-md-3 col-sm-6 mb-3">
            <div class="card indicator-card stat-card">
              <div class="card-body">
                <div class="indicator-icon">
                  <i class="bi bi-car-front"></i>
                </div>
                <div class="indicator-value" id="totalValue">2430000</div>
                <div class="indicator-label">Valeur totale véhicules (MAD)</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Filters -->
        <div class="filter-section">
          <h5 class="mb-4">
            <i class="bi bi-funnel me-2"></i>Filtrage des données
          </h5>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="cityFilter" class="form-label">Ville</label>
              <select class="form-select" id="cityFilter">
                <option value="">Toutes les villes</option>
              </select>
            </div>
            <div class="col-md-4 mb-3">
              <label for="insuranceFilter" class="form-label"
                >Type d'assurance</label
              >
              <select class="form-select" id="insuranceFilter">
                <option value="">Tous les types</option>
                <option value="Tiers">Tiers</option>
                <option value="Tiers+">Tiers+</option>
                <option value="Tous Risques">Tous Risques</option>
              </select>
            </div>
            <div class="col-md-4 mb-3">
              <label for="vehicleFilter" class="form-label"
                >Type de véhicule</label
              >
              <select class="form-select" id="vehicleFilter">
                <option value="">Tous les types</option>
                <option value="Voiture">Voiture</option>
                <option value="Moto">Moto</option>
                <option value="Camion">Camion</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div class="col-12">
              <button class="btn btn-secondary" id="resetFilters">
                <i class="bi bi-arrow-clockwise me-2"></i>Réinitialiser les
                filtres
              </button>
              <button class="btn btn-import float-end" id="importNewBtn">
                <i class="bi bi-upload me-2"></i>Importer un nouveau fichier
              </button>
            </div>
          </div>
        </div>

        <!-- Charts and Data -->
        <div class="row">
          <!-- Contracts Table -->
          <div class="col-lg-8 mb-4">
            <div class="card">
              <div class="card-header">
                <i class="bi bi-table me-2"></i>Tableau des Contrats
              </div>
              <div class="card-body">
                <div class="table-container">
                  <table
                    class="table table-striped data-table"
                    id="contractsTable"
                  >
                    <thead>
                      <tr>
                        <th>ID</th>
                        <th>Nom & Prénom</th>
                        <th>Ville</th>
                        <th>Type-Véhicule</th>
                        <th>Type Assurance</th>
                        <th>Prime (MAD)</th>
                      </tr>
                    </thead>
                    <tbody id="contractsTableBody">
                      <!-- Les données seront insérées ici via JavaScript -->
                    </tbody>
                  </table>
                </div>
                <div class="mt-3 text-end">
                  <span id="tableCount">0</span> contrats affichés
                </div>
              </div>
            </div>
          </div>

          <!-- Charts -->
          <div class="col-lg-4 mb-4">
            <div class="card">
              <div class="card-header">
                <i class="bi bi-pie-chart me-2"></i>Répartition par type
                d'assurance
              </div>
              <div class="card-body">
                <div class="chart-container">
                  <canvas id="insuranceChart"></canvas>
                </div>
                <div class="row mt-3 text-center">
                  <div class="col-4">
                    <span class="badge bg-secondary p-2"
                      >Tiers: <span id="tiersCount">6</span></span
                    >
                  </div>
                  <div class="col-4">
                    <span class="badge bg-primary p-2"
                      >Tiers+: <span id="tiersPlusCount">7</span></span
                    >
                  </div>
                  <div class="col-4">
                    <span class="badge bg-success p-2"
                      >Tous Risques: <span id="allRisksCount">7</span></span
                    >
                  </div>
                </div>
              </div>
            </div>

            <div class="card mt-4">
              <div class="card-header">
                <i class="bi bi-bar-chart me-2"></i>Répartition par type de
                véhicule
              </div>
              <div class="card-body">
                <div class="chart-container">
                  <canvas id="vehicleChart"></canvas>
                </div>
                <div class="row mt-3 text-center">
                  <div class="col-4">
                    <span class="badge bg-warning text-dark p-2"
                      >Voiture: <span id="carCount">0</span></span
                    >
                  </div>
                  <div class="col-4">
                    <span class="badge bg-info p-2"
                      >Moto: <span id="motoCount">0</span></span
                    >
                  </div>
                  <div class="col-4">
                    <span class="badge bg-danger p-2"
                      >Camion: <span id="truckCount">0</span></span
                    >
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="footer">
      <div class="container">
        <div class="row">
          <div class="col-md-6">
            <h5>Tableau de Bord Assurances Auto</h5>
            <p>
              Solution interactive pour la visualisation et l'analyse des
              données d'assurances auto.
            </p>
          </div>
          <div class="col-md-6 text-end">
            <p>
              <i class="bi bi-code-slash me-2"></i>Développé avec HTML, CSS,
              Bootstrap, jQuery & SheetJS
              <br />
              <small>Généré avec l'aide de DeepSeek AI</small>
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
      // Données par défaut basées sur l'exemple Excel fourni
      const defaultData = [
        {
          id: 1,
          name: "El Amrani Youssef",
          city: "Ouarzazate",
          vehicleType: "Moto",
          insuranceType: "Tiers+",
          premium: 1500,
          value: 93000,
        },
        {
          id: 2,
          name: "Ait Lahcen Fatima",
          city: "Ouarzazate",
          vehicleType: "Camion",
          insuranceType: "Tous Risques",
          premium: 1600,
          value: 96000,
        },
        {
          id: 3,
          name: "Benali Ahmed",
          city: "Marrakech",
          vehicleType: "Voiture",
          insuranceType: "Tiers",
          premium: 1600,
          value: 99000,
        },
        {
          id: 4,
          name: "El Idrissi Salma",
          city: "Rabat",
          vehicleType: "Moto",
          insuranceType: "Tiers+",
          premium: 1700,
          value: 102000,
        },
        {
          id: 5,
          name: "Chraibi Mohamed",
          city: "Casablanca",
          vehicleType: "Camion",
          insuranceType: "Tous Risques",
          premium: 1800,
          value: 105000,
        },
        {
          id: 6,
          name: "Tahiri Khadija",
          city: "Agadir",
          vehicleType: "Voiture",
          insuranceType: "Tiers",
          premium: 1860,
          value: 108000,
        },
        {
          id: 7,
          name: "Bennani Omar",
          city: "Marrakech",
          vehicleType: "Moto",
          insuranceType: "Tiers+",
          premium: 1920,
          value: 111000,
        },
        {
          id: 8,
          name: "El Fassi Imane",
          city: "Fes",
          vehicleType: "Camion",
          insuranceType: "Tous Risques",
          premium: 1980,
          value: 114000,
        },
        {
          id: 9,
          name: "Alaoui Hassan",
          city: "Rabat",
          vehicleType: "Voiture",
          insuranceType: "Tiers",
          premium: 2040,
          value: 117000,
        },
        {
          id: 10,
          name: "Zerouali Nadia",
          city: "Agadir",
          vehicleType: "Moto",
          insuranceType: "Tiers+",
          premium: 2100,
          value: 120000,
        },
        {
          id: 11,
          name: "Skalli Abdelilah",
          city: "Casablanca",
          vehicleType: "Camion",
          insuranceType: "Tous Risques",
          premium: 2160,
          value: 123000,
        },
        {
          id: 12,
          name: "Raji Siham",
          city: "Marrakech",
          vehicleType: "Voiture",
          insuranceType: "Tiers",
          premium: 2220,
          value: 126000,
        },
        {
          id: 13,
          name: "Ouahbi Anas",
          city: "Ouarzazate",
          vehicleType: "Moto",
          insuranceType: "Tiers+",
          premium: 2280,
          value: 129000,
        },
        {
          id: 14,
          name: "Amine Soukaina",
          city: "Agadir",
          vehicleType: "Camion",
          insuranceType: "Tous Risques",
          premium: 2340,
          value: 132000,
        },
        {
          id: 15,
          name: "Mouline Rachid",
          city: "Casablanca",
          vehicleType: "Voiture",
          insuranceType: "Tiers",
          premium: 2400,
          value: 135000,
        },
        {
          id: 16,
          name: "Lahlou Sara",
          city: "Rabat",
          vehicleType: "Moto",
          insuranceType: "Tiers+",
          premium: 2460,
          value: 138000,
        },
        {
          id: 17,
          name: "Kabbaj Yassine",
          city: "Marrakech",
          vehicleType: "Camion",
          insuranceType: "Tous Risques",
          premium: 2520,
          value: 141000,
        },
        {
          id: 18,
          name: "Bouzidi Amina",
          city: "Ouarzazate",
          vehicleType: "Voiture",
          insuranceType: "Tiers",
          premium: 2580,
          value: 144000,
        },
        {
          id: 19,
          name: "El Mansouri Karim",
          city: "Agadir",
          vehicleType: "Moto",
          insuranceType: "Tiers+",
          premium: 2640,
          value: 147000,
        },
        {
          id: 20,
          name: "Haddad Latifa",
          city: "Casablanca",
          vehicleType: "Camion",
          insuranceType: "Tous Risques",
          premium: 2700,
          value: 150000,
        },
      ];

      let contractsData = [...defaultData];
      let insuranceChart, vehicleChart;

      // Initialisation de la page
      $(document).ready(function () {
        initializeDashboard();
        setupEventListeners();
        loadDefaultData();
      });

      // Initialisation du tableau de bord
      function initializeDashboard() {
        // Initialiser les sélecteurs de filtre avec les villes uniques
        const cities = [...new Set(contractsData.map((item) => item.city))];
        const cityFilter = $("#cityFilter");
        cities.forEach((city) => {
          cityFilter.append(`<option value="${city}">${city}</option>`);
        });

        // Afficher les données par défaut
        updateDashboard();

        // Initialiser les graphiques
        initializeCharts();
      }

      // Configuration des écouteurs d'événements
      function setupEventListeners() {
        // Bouton de sélection de fichier
        $("#selectFileBtn").click(function () {
          $("#fileInput").click();
        });

        // Zone de dépôt de fichier
        $("#dropArea").on("dragover", function (e) {
          e.preventDefault();
          $(this).addClass("bg-light");
        });

        $("#dropArea").on("dragleave", function (e) {
          e.preventDefault();
          $(this).removeClass("bg-light");
        });

        $("#dropArea").on("drop", function (e) {
          e.preventDefault();
          $(this).removeClass("bg-light");
          const files = e.originalEvent.dataTransfer.files;
          if (files.length > 0) {
            handleFileUpload(files[0]);
          }
        });

        // Changement de fichier via input
        $("#fileInput").change(function (e) {
          if (this.files.length > 0) {
            handleFileUpload(this.files[0]);
          }
        });

        // Onglets de navigation
        $("#importTab").click(function (e) {
          e.preventDefault();
          $("#dashboardSection").hide();
          $("#importSection").show();
        });

        $("#dashboardTab").click(function (e) {
          e.preventDefault();
          $("#importSection").hide();
          $("#dashboardSection").show();
        });

        $("#importNewBtn").click(function (e) {
          e.preventDefault();
          $("#dashboardSection").hide();
          $("#importSection").show();
        });

        // Filtres
        $("#cityFilter, #insuranceFilter, #vehicleFilter").change(function () {
          filterData();
        });

        // Réinitialisation des filtres
        $("#resetFilters").click(function () {
          $("#cityFilter").val("");
          $("#insuranceFilter").val("");
          $("#vehicleFilter").val("");
          filterData();
        });
      }

      // Chargement des données par défaut
      function loadDefaultData() {
        contractsData = [...defaultData];
        $("#fileInfo").removeClass("d-none").addClass("alert-info");
        $("#fileName").html(
          "<strong>Fichier chargé :</strong> Données par défaut"
        );
        updateDashboard();
      }

      // Traitement du fichier uploadé
      function handleFileUpload(file) {
        const fileInfo = $("#fileInfo");
        const fileName = $("#fileName");

        if (!file.name.match(/\.(xlsx|xls)$/)) {
          fileInfo.removeClass("d-none alert-info").addClass("alert-danger");
          fileName.html(
            "<strong>Erreur :</strong> Veuillez sélectionner un fichier Excel (xlsx ou xls)"
          );
          return;
        }

        fileInfo.removeClass("d-none alert-danger").addClass("alert-info");
        fileName.html(`<strong>Chargement :</strong> ${file.name}...`);

        const reader = new FileReader();

        reader.onload = function (e) {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: "array" });

            // Chercher la feuille avec les données d'assurances
            let sheetName = workbook.SheetNames.find(
              (name) =>
                name.toLowerCase().includes("assurances") ||
                name.toLowerCase().includes("feuil") ||
                name.toLowerCase().includes("sheet")
            );

            if (!sheetName) sheetName = workbook.SheetNames[0];

            const worksheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

            // Transformer les données Excel en format utilisable
            processExcelData(jsonData);

            fileInfo.removeClass("alert-info").addClass("alert-success");
            fileName.html(
              `<strong>Succès :</strong> ${file.name} chargé (${contractsData.length} contrats)`
            );

            // Passer au tableau de bord
            setTimeout(() => {
              $("#importSection").hide();
              $("#dashboardSection").show();
              updateDashboard();
            }, 1000);
          } catch (error) {
            console.error("Erreur lors de la lecture du fichier:", error);
            fileInfo.removeClass("alert-info").addClass("alert-danger");
            fileName.html(
              `<strong>Erreur :</strong> Impossible de lire le fichier. Utilisation des données par défaut.`
            );

            // Charger les données par défaut en cas d'erreur
            setTimeout(() => {
              loadDefaultData();
              $("#importSection").hide();
              $("#dashboardSection").show();
            }, 1500);
          }
        };

        reader.onerror = function () {
          fileInfo.removeClass("alert-info").addClass("alert-danger");
          fileName.html(
            "<strong>Erreur :</strong> Impossible de lire le fichier. Utilisation des données par défaut."
          );

          setTimeout(() => {
            loadDefaultData();
            $("#importSection").hide();
            $("#dashboardSection").show();
          }, 1500);
        };

        reader.readAsArrayBuffer(file);
      }

      // Traitement des données Excel
      function processExcelData(excelData) {
        contractsData = [];

        // Trouver les indices de colonnes
        const headerRow = excelData[0] || [];
        const idIndex = headerRow.findIndex(
          (col) => col && col.toString().toLowerCase().includes("id")
        );
        const nameIndex = headerRow.findIndex(
          (col) =>
            col &&
            (col.toString().toLowerCase().includes("nom") ||
              col.toString().toLowerCase().includes("name"))
        );
        const cityIndex = headerRow.findIndex(
          (col) => col && col.toString().toLowerCase().includes("ville")
        );
        const vehicleIndex = headerRow.findIndex(
          (col) =>
            col &&
            col.toString().toLowerCase().includes("type") &&
            col.toString().toLowerCase().includes("vehicule")
        );
        const insuranceIndex = headerRow.findIndex(
          (col) =>
            col &&
            col.toString().toLowerCase().includes("type") &&
            col.toString().toLowerCase().includes("assurance")
        );
        const premiumIndex = headerRow.findIndex(
          (col) =>
            col &&
            (col.toString().toLowerCase().includes("prime") ||
              col.toString().toLowerCase().includes("premium"))
        );
        const valueIndex = headerRow.findIndex(
          (col) => col && col.toString().toLowerCase().includes("valeur")
        );

        // Parcourir les lignes de données (en commençant à la ligne 1 pour ignorer l'en-tête)
        for (let i = 1; i < excelData.length; i++) {
          const row = excelData[i] || [];

          // S'assurer que nous avons au moins les données minimales
          if (row[idIndex] && row[nameIndex]) {
            const contract = {
              id: row[idIndex] || i,
              name: row[nameIndex] || `Client ${i}`,
              city: row[cityIndex] || "Inconnue",
              vehicleType: row[vehicleIndex] || "Inconnu",
              insuranceType: row[insuranceIndex] || "Inconnu",
              premium: parseFloat(row[premiumIndex]) || 0,
              value: parseFloat(row[valueIndex]) || 0,
            };

            // Normaliser les types d'assurance
            if (contract.insuranceType.includes("Tiers+")) {
              contract.insuranceType = "Tiers+";
            } else if (contract.insuranceType.includes("Tous Risques")) {
              contract.insuranceType = "Tous Risques";
            } else if (contract.insuranceType.includes("Tiers")) {
              contract.insuranceType = "Tiers";
            }

            // Normaliser les types de véhicule
            if (
              contract.vehicleType.toLowerCase().includes("voiture") ||
              contract.vehicleType.toLowerCase().includes("car")
            ) {
              contract.vehicleType = "Voiture";
            } else if (contract.vehicleType.toLowerCase().includes("moto")) {
              contract.vehicleType = "Moto";
            } else if (
              contract.vehicleType.toLowerCase().includes("camion") ||
              contract.vehicleType.toLowerCase().includes("truck")
            ) {
              contract.vehicleType = "Camion";
            }

            contractsData.push(contract);
          }
        }

        // Si aucune donnée n'a été extraite, utiliser les données par défaut
        if (contractsData.length === 0) {
          contractsData = [...defaultData];
        }

        // Mettre à jour le filtre des villes
        updateCityFilter();
      }

      // Mise à jour du filtre des villes
      function updateCityFilter() {
        const cityFilter = $("#cityFilter");
        const currentValue = cityFilter.val();

        cityFilter.empty();
        cityFilter.append('<option value="">Toutes les villes</option>');

        const cities = [...new Set(contractsData.map((item) => item.city))];
        cities.forEach((city) => {
          cityFilter.append(`<option value="${city}">${city}</option>`);
        });

        // Restaurer la valeur précédente si elle existe toujours
        if (cities.includes(currentValue)) {
          cityFilter.val(currentValue);
        }
      }

      // Mise à jour du tableau de bord
      function updateDashboard() {
        updateIndicators();
        updateTable();
        updateCharts();
      }

      // Mise à jour des indicateurs clés
      function updateIndicators() {
        const totalContracts = contractsData.length;
        const totalPremium = contractsData.reduce(
          (sum, item) => sum + item.premium,
          0
        );
        const avgPremium =
          totalContracts > 0 ? Math.round(totalPremium / totalContracts) : 0;
        const totalValue = contractsData.reduce(
          (sum, item) => sum + item.value,
          0
        );

        $("#contractCount").text(totalContracts);
        $("#avgPremium").text(avgPremium.toLocaleString());
        $("#totalPremium").text(totalPremium.toLocaleString());
        $("#totalValue").text(totalValue.toLocaleString());
      }

      // Mise à jour du tableau des contrats
      function updateTable(filteredData = contractsData) {
        const tableBody = $("#contractsTableBody");
        tableBody.empty();

        filteredData.forEach((contract) => {
          const row = `
                    <tr>
                        <td>${contract.id}</td>
                        <td>${contract.name}</td>
                        <td><span class="badge bg-secondary">${
                          contract.city
                        }</span></td>
                        <td><span class="badge bg-warning text-dark">${
                          contract.vehicleType
                        }</span></td>
                        <td>
                            ${
                              contract.insuranceType === "Tiers+"
                                ? '<span class="badge bg-primary">Tiers+</span>'
                                : contract.insuranceType === "Tous Risques"
                                ? '<span class="badge bg-success">Tous Risques</span>'
                                : '<span class="badge bg-secondary">Tiers</span>'
                            }
                        </td>
                        <td><strong>${contract.premium.toLocaleString()}</strong> MAD</td>
                    </tr>
                `;
          tableBody.append(row);
        });

        $("#tableCount").text(filteredData.length);
      }

      // Initialisation des graphiques
      function initializeCharts() {
        const insuranceCtx = document
          .getElementById("insuranceChart")
          .getContext("2d");
        const vehicleCtx = document
          .getElementById("vehicleChart")
          .getContext("2d");

        insuranceChart = new Chart(insuranceCtx, {
          type: "doughnut",
          data: {
            labels: ["Tiers", "Tiers+", "Tous Risques"],
            datasets: [
              {
                data: [6, 7, 7],
                backgroundColor: ["#6c757d", "#3498db", "#27ae60"],
                borderWidth: 2,
                borderColor: "#fff",
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "bottom",
                labels: {
                  padding: 20,
                  font: {
                    size: 12,
                  },
                },
              },
            },
          },
        });

        vehicleChart = new Chart(vehicleCtx, {
          type: "bar",
          data: {
            labels: ["Voiture", "Moto", "Camion"],
            datasets: [
              {
                label: "Nombre de véhicules",
                data: [8, 7, 5],
                backgroundColor: [
                  "rgba(255, 193, 7, 0.8)",
                  "rgba(23, 162, 184, 0.8)",
                  "rgba(220, 53, 69, 0.8)",
                ],
                borderColor: [
                  "rgb(255, 193, 7)",
                  "rgb(23, 162, 184)",
                  "rgb(220, 53, 69)",
                ],
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1,
                },
              },
            },
            plugins: {
              legend: {
                display: false,
              },
            },
          },
        });
      }

      // Mise à jour des graphiques
      function updateCharts() {
        // Calculer les répartitions
        const insuranceCounts = {
          Tiers: contractsData.filter((c) => c.insuranceType === "Tiers")
            .length,
          "Tiers+": contractsData.filter((c) => c.insuranceType === "Tiers+")
            .length,
          "Tous Risques": contractsData.filter(
            (c) => c.insuranceType === "Tous Risques"
          ).length,
        };

        const vehicleCounts = {
          Voiture: contractsData.filter((c) => c.vehicleType === "Voiture")
            .length,
          Moto: contractsData.filter((c) => c.vehicleType === "Moto").length,
          Camion: contractsData.filter((c) => c.vehicleType === "Camion")
            .length,
        };

        // Mettre à jour les compteurs affichés
        $("#tiersCount").text(insuranceCounts["Tiers"]);
        $("#tiersPlusCount").text(insuranceCounts["Tiers+"]);
        $("#allRisksCount").text(insuranceCounts["Tous Risques"]);

        $("#carCount").text(vehicleCounts["Voiture"]);
        $("#motoCount").text(vehicleCounts["Moto"]);
        $("#truckCount").text(vehicleCounts["Camion"]);

        // Mettre à jour les graphiques
        if (insuranceChart) {
          insuranceChart.data.datasets[0].data = [
            insuranceCounts["Tiers"],
            insuranceCounts["Tiers+"],
            insuranceCounts["Tous Risques"],
          ];
          insuranceChart.update();
        }

        if (vehicleChart) {
          vehicleChart.data.datasets[0].data = [
            vehicleCounts["Voiture"],
            vehicleCounts["Moto"],
            vehicleCounts["Camion"],
          ];
          vehicleChart.update();
        }
      }

      // Filtrage des données
      function filterData() {
        const city = $("#cityFilter").val();
        const insuranceType = $("#insuranceFilter").val();
        const vehicleType = $("#vehicleFilter").val();

        let filteredData = contractsData;

        if (city) {
          filteredData = filteredData.filter((item) => item.city === city);
        }

        if (insuranceType) {
          filteredData = filteredData.filter(
            (item) => item.insuranceType === insuranceType
          );
        }

        if (vehicleType) {
          filteredData = filteredData.filter(
            (item) => item.vehicleType === vehicleType
          );
        }

        updateTable(filteredData);

        // Mettre à jour les indicateurs avec les données filtrées
        const totalContracts = filteredData.length;
        const totalPremium = filteredData.reduce(
          (sum, item) => sum + item.premium,
          0
        );
        const avgPremium =
          totalContracts > 0 ? Math.round(totalPremium / totalContracts) : 0;
        const totalValue = filteredData.reduce(
          (sum, item) => sum + item.value,
          0
        );

        $("#contractCount").text(totalContracts);
        $("#avgPremium").text(avgPremium.toLocaleString());
        $("#totalPremium").text(totalPremium.toLocaleString());
        $("#totalValue").text(totalValue.toLocaleString());
      }
    </script>
  </body>
</html>
